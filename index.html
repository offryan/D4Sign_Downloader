<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <title>Documentos Assinados</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" type="text/css" href="style/style.css">
</head>
<body>
    <div class="page">
        <div class="card">
            <form method="POST" id="filtro-form" class="controls">
                <div class="group">
                    <label>Lote por fundo</label>
                    <select name="cofre" onchange="this.form.submit()">
                        <option value="">Todos os cofres</option>
                        {% for cofre in cofres %}
                            <option value="{{ cofre.get('uuid') or cofre.get('uuid_safe') or cofre.get('uuid-safe') }}"
                                {% if cofre_selecionado == (cofre.get('uuid') or cofre.get('uuid_safe') or cofre.get('uuid-safe')) %}selected{% endif %}>
                                {{ cofre.get('name') or cofre.get('name_safe') or cofre.get('name-safe') }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="group">
                    <label>Buscar por nome</label>
                    <input type="text" id="busca-nome" name="busca_nome" value="{{ busca_nome }}" placeholder="Pesquisar documento..." autocomplete="off">
                </div>

                <div class="group" style="position:relative">
                    <label>PerÃ­odo (assinatura)</label>
                    <div style="display:flex;gap:8px;align-items:center">
                        <input type="text" id="data-periodo" name="data_periodo" placeholder="YYYY-MM-DD - YYYY-MM-DD" value="{{ (data_inicio and data_fim) and (data_inicio ~ ' - ' ~ data_fim) or (data_periodo or '') }}" readonly style="cursor:pointer">
                        <button type="button" class="download-btn" id="btn-data-periodo" style="padding:6px 8px">ðŸ“…</button>
                    </div>
                    <!-- hidden fields to submit legacy names -->
                    <input type="hidden" name="data_inicio" id="data_inicio_hidden" value="{{ data_inicio or '' }}">
                    <input type="hidden" name="data_fim" id="data_fim_hidden" value="{{ data_fim or '' }}">
                    <div id="data-periodo-popup" class="range-popup" style="display:none;position:absolute;z-index:80;background:#fff;padding:10px;border:1px solid var(--border);box-shadow:0 6px 18px rgba(15,23,42,0.06);border-radius:8px">
                        <div style="display:flex;gap:8px;align-items:center"><input type="date" id="data-periodo-start"> <span style="font-size:12px;color:var(--muted)">atÃ©</span> <input type="date" id="data-periodo-end"></div>
                        <div id="data-periodo-error" class="range-error" style="display:none;margin-top:8px;color:#b91c1c;font-size:12px"></div>
                        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button type="button" class="download-btn" id="data-periodo-apply">Aplicar</button><button type="button" id="data-periodo-cancel" style="background:#eee;color:#111;padding:6px 10px;border-radius:8px;border:none">Cancelar</button></div>
                    </div>
                </div>

                <!-- ordering is now controlled by clicking the table header -->
                <input type="hidden" name="ordenar_por" id="ordenar_por" value="{{ ordenar_por or '' }}">
                <!-- filter for view status: default 'finalizado' or 'baixado' -->
                <input type="hidden" name="view_status" id="view_status_hidden" value="{{ request.form.get('view_status','') or request.args.get('view_status','') or 'finalizado' }}">
            </form>

            <div class="title-row">
                <h1>Documentos assinados</h1>
                <div style="display:flex;gap:12px;align-items:center">
                    <div style="color:var(--muted);font-size:13px"><div>Mostrando {{ documentos|length }} documentos</div></div>

                    <div class="downloaded-counter" id="downloaded-counter" title="Total de arquivos baixados">
                        <span style="font-weight:600">Baixados:</span>
                        <span id="downloaded-count" class="count-val">{{ total_downloaded or 0 }}</span>
                    </div>
                    <button id="dark-mode-toggle" title="Alternar modo noturno" aria-label="Alternar modo noturno">
                        <span class="toggle-icon toggle-sun" aria-hidden="true"></span>
                        <span class="toggle-icon toggle-moon" aria-hidden="true"></span>
                    </button>
                </div>
            </div>

            <form method="POST" id="download-form">
                <table>
                    <thead>
                        <tr>
                            <th style="width:70px"><div class="master-wrap"><input type="checkbox" id="master-check" title="Selecionar todos"><span id="selected-count">0</span></div></th>
                            <th>Documento</th>
                            <th style="width:140px" class="sortable {% if ordenar_por in ['data_desc','data_asc'] %}active-sort{% endif %}" id="th-data">Data <span id="sort-arrow-data">{% if ordenar_por=='data_desc' %}<span class="sort-icon">{{ ICON_UP|safe }}</span>{% elif ordenar_por=='data_asc' %}<span class="sort-icon">{{ ICON_DOWN|safe }}</span>{% else %}<span class="sort-icon">{{ ICON_UP|safe }}</span>{% endif %}</span></th>

                            <th style="width:160px">Cofre</th>
                            <th style="width:120px">
                                                <div class="status-header" style="display:flex;align-items:center;gap:8px">
                                                    <span style="font-weight:600;font-size:13px">Status</span>
                                                    <select id="status-filter" name="status_filter" onchange="setViewStatusAndSubmit(this.value)" style="min-width:140px;padding:6px;border-radius:6px;border:1px solid var(--border)">
                                                        <option value="finalizado" {% if view_status == 'finalizado' %}selected{% endif %}>Finalizado</option>
                                                        <option value="baixado" {% if view_status == 'baixado' %}selected{% endif %}>Arquivos baixados</option>
                                                        <option value="nao_baixado" {% if view_status == 'nao_baixado' %}selected{% endif %}>NÃ£o baixados</option>
                                                    </select>
                                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in documentos %}
                        <tr>
                            <td>
                                <input type="checkbox" name="documentos" value="{{ doc['uuidDoc'] }}">
                                <input type="hidden" name="doc_nomes[{{ doc['uuidDoc'] }}]" value="{{ doc['nomeOriginal'] }}">
                            </td>
                            <td class="doc-name">{{ doc['nomeLimpo'] }}</td>
                            <td class="date-col" data-label="Data">{{ doc['dataAssinatura'] }}</td>

                            <td>{{ doc['cofre_nome'] }}</td>
                            <td>
                                {{ doc['statusName'] }}
                                {% if doc.get('baixado') %}
                                    <span class="baixado-badge">Baixado</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            <div class="download-area">
                <div style="color:var(--muted);font-size:13px">Selecione documentos para baixar</div>
            <div style="display:flex;gap:8px">
                <button name="download" class="download-btn">Download Selecionados</button>
            </div>
            </div>
            </form>
        </div>
    <!-- icon templates (hidden) - wrapped so injected HTML includes .sort-icon -->
    <template id="icon-up-tpl"><span class="sort-icon">{{ ICON_UP|safe }}</span></template>
    <template id="icon-down-tpl"><span class="sort-icon">{{ ICON_DOWN|safe }}</span></template>
    <!-- theme icons -->
    <template id="icon-sun-tpl"><span class="sort-icon">{{ ICON_SUN|safe }}</span></template>
    <template id="icon-moon-tpl"><span class="sort-icon">{{ ICON_MOON|safe }}</span></template>
    </div>

        <div id="downloadModal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">&times;</span>
            <div class="modal-body">
                <div id="modalSpinner" class="modal-spinner" aria-hidden="true"></div>
                <div id="modalIcon" class="modal-icon" style="display:none" aria-hidden="true"></div>
                <h2 id="modalTitle">Aguarde enquanto o download inicia...</h2>
                <div id="modalMsg" class="msg"></div>
                <div class="modal-actions"></div>
            </div>
        </div>
    </div>
    <script src="scripts/script.js" defer></script>
</body>
</html>